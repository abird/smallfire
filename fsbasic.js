function e(a){const[n]=Object.keys(a),o=a[n];switch(n){case"mapValue":return t(o.fields);case"arrayValue":return o.values.map((t=>e(t)));case"integerValue":return+o;case"timestampValue":return new Date(o);default:return o}}function t(t){const a={};for(const n of Object.keys(t))a[n]=e(t[n]);return a}function a(e){if(Array.isArray(e))return e.map((e=>a(e)));if(e.fields)return t(e.fields);if(e.documents){return{documents:e.documents.map((e=>a(e))),nextPageToken:e.nextPageToken}}return e.document?a(e.document):void 0}function n(e){const t=typeof e;return"number"===t?Number.isInteger(e)?{integerValue:String(e)}:{doubleValue:e}:"boolean"===t?{booleanValue:e}:null===e?{nullValue:null}:e instanceof Date?{timestampValue:e.toISOString()}:"string"===t?e.match(/projects\/.*?\/databases\/.*?\/documents\//)?{referenceValue:e}:{stringValue:e}:Array.isArray(e)?{arrayValue:{values:e.map((e=>n(e)))}}:e.latitude&&e.longitude&&2===Object.keys(e).length?{geoPointValue:e}:{mapValue:o(e)}}function o(e){const t={};for(const a of Object.keys(e))t[a]=n(e[a]);return{fields:t}}function s(e){return o(e)}let r=0;function c(){return Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())).toString(36)}function i(e,t){return`${firestoreHost()}/google.firestore.v1.Firestore/Listen/channel?${t}`}function d(e,t){const n=e=>{if(!["noop","close"].includes(e))if(e.documentChange){const n=a(e.documentChange.document);t&&t(n)}else e.targetChange||console.log("Unknown request:",e)},o=JSON.parse(e);let s,r=0;for([r,s]of o)if(Array.isArray(s))for(const e of s)n(e);else n(s);return r}async function u(e,t){const a=`database=projects/${e.database}/databases/(default)&gsessionid=${e.sessionId}&VER=8&RID=rpc&SID=${e.SID}&AID=${e.AID}&TYPE=xmlhttp&zx=${c()}&t=1`,n=i(e.host,a),o=new TextDecoder("utf-8"),s=await fetch(n,{method:"GET",mode:"cors",cache:"no-cache",headers:{pragma:"no-cache","cache-control":"no-cache"}});if(!s.body)throw s.statusText;{const a=s.body.getReader();let n,r,c=0,i="";for(;!n;)if(({value:r,done:n}=await a.read()),!n)for(r=r?o.decode(r,{stream:!0}):"";r.length;){if(!c){const e=r.indexOf("\n");c=+r.slice(0,e),r=r.slice(e+1)}c<=r.length?(i=r.slice(0,c),r=r.slice(c),e.AID=d(i,t),c=0,i=""):i+=r}e.closed||(a.releaseLock(),u(e,t))}}function l(e,t,a){const n={dbinfo:e,documentPath:t,AID:0,RID:Math.round(64e3*Math.random())};return async function(e,t){const a=`database=projects/${e.database}/databases/(default)&VER=8&RID=${e.RID++}&CVER=22&X-HTTP-Session-Id=gsessionid&$httpHeaders=X-Goog-Api-Client:gl-js/ fire/8.3.1\nContent-Type:text/plain\n&zx=${c()}&t=1`,n=i(e.host,a);e.targetId=r+=2;const o=await fetch(n,{method:"POST",mode:"cors",cache:"no-cache",body:`count=1&ofs=0&req0___data__={"database":"projects/${e.database}/databases/(default)","addTarget":{"documents":{"documents":["projects/${e.database}/databases/(default)/documents/${e.documentPath}"]},"targetId":${e.targetId}}}`});if(!o.ok)throw o.statusText;const s=o.headers;e.sessionId=s.get("x-http-session-id");const d=await o.text(),u=JSON.parse(d.split("\n")[1]);e.SID=u[0][1][1],t&&t()}(n,(()=>u(n,a))),()=>async function(e){if(!e.closed){const t=`database=projects/${e.database}/databases/(default)&VER=8&gsessionid=${e.sessionId}&SID=${e.SID}&RID=${e.RID++}&AID=${e.AID}&zx=${c()}&t=1`,a=i(e.host,t);await fetch(a,{method:"POST",mode:"cors",cache:"no-cache",body:`count=1&ofs=1&req0___data__={"database":"projects/${e.database}/databases/(default)","removeTarget":${e.targetId}}`,headers:{"Content-Type":"application/x-www-form-urlencoded",pragma:"no-cache","cache-control":"no-cache"}}),e.closed=!0}}(n)}function f(){const e=localStorage.getItem("Firebase-Auth-Data");return e&&JSON.parse(e)}function h(e){localStorage.setItem("Firebase-Auth-Data",JSON.stringify(e))}async function p(e,t,a,n){const o=`https://identitytoolkit.googleapis.com/v1/${e}?key=${t}`,s=await fetch(o,{method:"POST",mode:"cors",cache:"no-cache",headers:{pragma:"no-cache","cache-control":"no-cache","Content-Type":n||"application/json"},body:JSON.stringify(a)}),r=await s.json();if(!s.ok)throw r;return r}async function m(e,t,a){const n=await p("accounts:signInWithPassword",a,{email:e,password:t,returnSecureToken:!0});return h(n),n}function g(){localStorage.removeItem("Firebase-Auth-Data")}const b=e=>{throw e};async function y(e,t,n,o,s){const r=function(e,t,a){t.startsWith(":")||(t="/"+t);let n=`${e.host}/v1/projects/${e.database}/databases/(default)/documents${t}`;if(a){const e=new URLSearchParams;Object.entries(a).map((([t,a])=>{["mask","updateMask","select","project"].includes(t)?(["select","project"].includes(t)&&(t="mask"),a.map((a=>e.append(`${t}.fieldPaths`,a)))):e.append(t,a)})),n=`${n}?${e.toString()}`}return n}(e,t,n),c={method:o||"GET",mode:"cors",cache:"no-cache",headers:{pragma:"no-cache","cache-control":"no-cache"}};e.auth&&(c.headers.Authorization=`Bearer ${e.auth.idToken}`),s&&(c.body=JSON.stringify(s));let i=await fetch(r,c),d=await i.json();return i.ok||(e.auth&&"INVALID_ID_TOKEN"===d.error.message?(console.log("Refreshing token"),e.auth=await async function(e){const t=await p("token",e.localId,`grant_type=refresh_token&refresh_token=${e.refreshToken}`,"application/x-www-form-urlencoded");return(e={...e}).idToken=t.id_token,e.refreshToken=t.refresh_token,h(e),e}(e.auth),i=await fetch(r,c),d=await i.json(),i.ok||b(d)):b(d)),a(d)}const A=e=>!(1&e.split("/").length),w=e=>{if(((e,t)=>{Array.isArray(e)||b(`"${t}" value must be an array`)})(e,"where"),Array.isArray(e[0]))return{compositeFilter:{op:"AND",filters:e.map((e=>w(e)))}};const[t,a,o]=e;a||b('"where" array needs 2 or 3 value');const s=o?"fieldFilter":"unaryFilter",r=(e=>({"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL","==":"EQUAL","=":"EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","!=":"NOT_EQUAL","<>":"NOT_EQUAL"}[e]||e.toUpperCase().replace(/\-/g,"_")))(a);r||b(`Invalid operator in where: ${a}`);const c={field:{fieldPath:t},op:r};return o&&(c.value=n(o)),{[s]:c}},I={listen:function(e,t){return l(this.dbinfo,e,t)},get:function(e,t){return(async(e,t,a)=>A(t)?y(e,t,a):b('Collection specified. Use "list" to get list of documents.'))(this.dbinfo,e,t)},query:function(e,t){return(async(e,t,a)=>{const o={};return Object.entries(t).map((([e,t])=>{const a=Array.isArray(t);switch(e){case"select":t={fields:a?t.map((e=>({fieldPath:e}))):[{fieldPath:t}]};break;case"from":t=a?t.map((e=>({collectionId:e}))):[{collectionId:t}];break;case"where":t=w(t);break;case"orderBy":const o=e=>{let t={};return e.startsWith("-")&&(e=e.slice(1),t.direction="DESCENDING"),t.field={fieldPath:e},t};t=a?t.map((e=>o(e))):[o(t)];break;case"startAt":case"startAfter":case"endAt":case"endBefore":t={values:[n(t)],before:["startAt","endBefore"].includes(e)},e=e.replace(/After|Before/,"At");break;default:t=n(t)}o[e]=t})),y(e,":runQuery",a,"POST",{structuredQuery:o})})(this.dbinfo,e,t)},list:function(e,t){return(async(e,t,a)=>A(t)?b('Document specified. Use "get" to get document.'):y(e,t,a))(this.dbinfo,e,t)},set:function(e,t,a){return(async(e,t,a,n)=>y(e,t,n,"PATCH",s(a)))(this.dbinfo,e,t,a)},update:function(e,t,a){return(async(e,t,a,n={})=>{const o=[],r=(e,t)=>{Object.entries(e).map((([e,a])=>{"Object"===a.constructor.name?r(a,`${t}${e}.`):o.push(t+e)}))};return r(a,""),n.updateMask=o,y(e,t,n,"PATCH",s(a))})(this.dbinfo,e,t,a)},delete:function(e,t){return(async(e,t,a)=>y(e,t,a,"DELETE"))(this.dbinfo,e,t)}};function $(e,t,a){const n={host:"https://firestore.googleapis.com",database:e,auth:t};return n.host=!1===a?"https://firestore.googleapis.com":a&&"string"==typeof a?a.startsWith("http")?a:`http://${a}`:"http://localhost:8080",{...I,dbinfo:n}}"undefined"!=typeof window&&(window.fsbasic={currentUser:f,signIn:m,signOut:g,getDB:$});export{f as currentUser,$ as getDB,m as signIn,g as signOut};

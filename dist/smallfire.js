function e(a){const[n]=Object.keys(a),o=a[n];switch(n){case"mapValue":return t(o.fields);case"arrayValue":return o.values.map((t=>e(t)));case"integerValue":return+o;case"timestampValue":return new Date(o);default:return o}}function t(t){const a={};for(const n of Object.keys(t))a[n]=e(t[n]);return a}function a(e){if(Array.isArray(e))return e.map((e=>a(e)));if(e.fields)return t(e.fields);if(e.documents){return{documents:e.documents.map((e=>a(e))),nextPageToken:e.nextPageToken}}return e.document?a(e.document):void 0}function n(e){const t=typeof e;return"number"===t?Number.isInteger(e)?{integerValue:String(e)}:{doubleValue:e}:"boolean"===t?{booleanValue:e}:null===e?{nullValue:null}:e instanceof Date?{timestampValue:e.toISOString()}:"string"===t?e.match(/projects\/.*?\/databases\/.*?\/documents\//)?{referenceValue:e}:{stringValue:e}:Array.isArray(e)?{arrayValue:{values:e.map((e=>n(e)))}}:e.latitude&&e.longitude&&2===Object.keys(e).length?{geoPointValue:e}:{mapValue:o(e)}}function o(e){const t={};for(const a of Object.keys(e))t[a]=n(e[a]);return{fields:t}}function s(e){return o(e)}let r=0;function i(){return Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())).toString(36)}async function c(e,t,a,n){const{host:o,auth:s}=e,r=function(e,t){return`https://firestore.googleapis.com/google.firestore.v1.Firestore/Listen/channel?${t}`}(0,t),i={method:a?"POST":"GET",mode:"cors",cache:"no-cache",headers:{pragma:"no-cache","cache-control":"no-cache"}};s&&(i.headers.Authorization=`Bearer ${s.idToken}`),a&&(i.body="string"==typeof a?a:JSON.stringify(a)),n&&Object.assign(i.headers,n);let d=await fetch(r,i);if(!d.ok){if(s&&401===d.status)return await s.tokenRefresh(),await c(e,t,a,n);throw d.statusText}return d}async function d(e,t){e.targetId=r+=2;const a=`database=projects/${e.database}/databases/(default)&VER=8&RID=${e.RID++}&CVER=22&X-HTTP-Session-Id=gsessionid&$httpHeaders=X-Goog-Api-Client:gl-js/ fire/8.3.1\nContent-Type:text/plain\n&zx=${i()}&t=1`,n=encodeURI(`count=1&ofs=0&req0___data__={"database":"projects/${e.database}/databases/(default)","addTarget":{"documents":{"documents":["projects/${e.database}/databases/(default)/documents/${e.documentPath}"]},"targetId":${e.targetId}}}`),o=await c(e,a,n,{"Content-Type":"application/x-www-form-urlencoded"}),s=o.headers;e.sessionId=s.get("x-http-session-id");const d=await o.text(),u=JSON.parse(d.split("\n")[1]);e.SID=u[0][1][1],t&&t()}function u(e,t){let n;const o=e=>{if(!["noop","close"].includes(e))if(e.documentChange){const n=a(e.documentChange.document);t&&t(n)}else if(e.targetChange){const{targetChange:t}=e;"REMOVE"===t.targetChangeType&&t.cause&&7===t.cause.code&&(n="permission")}else if(e.__sm__){const t=e.__sm__.status[0][0].error;t&&401===t.code&&(n="refresh")}else console.log("Unknown request:",e)},s=JSON.parse(e);let r,i=0;for([i,r]of s)if(Array.isArray(r))for(const e of r)o(e);else o(r);return{AID:i,error:n}}async function f(e,t,a){const n=`database=projects/${e.database}/databases/(default)&gsessionid=${e.sessionId}&VER=8&RID=rpc&SID=${e.SID}&AID=${e.AID}&TYPE=xmlhttp&zx=${i()}&t=1`,o=new TextDecoder("utf-8"),s=await c(e,n);if(s.body){const n=s.body.getReader();let r,i,c=0,h="";for(;!r;)if(({value:i,done:r}=await n.read()),!r)for(i=i?o.decode(i,{stream:!0}):"";i.length;){if(!c){const e=i.indexOf("\n");c=+i.slice(0,e),i=i.slice(e+1)}if(c<=i.length){h=i.slice(0,c),i=i.slice(c);const{AID:o,error:s}=u(h,t);if(e.AID=o,c=0,h="",s){const o={...e};return await l(o),"permission"===s?a&&a("Missing or insufficient permissions"):"refresh"===s&&(await e.auth.tokenRefresh(),e.AID=0,e.RID=Math.round(64e3*Math.random()),d(e,(()=>f(e,t)))),void n.releaseLock()}}else h+=i}e.closed||(n.releaseLock(),f(e,t))}else a&&a(s.statusText)}async function l(e){if(!e.closed){const t=`database=projects/${e.database}/databases/(default)&VER=8&gsessionid=${e.sessionId}&SID=${e.SID}&RID=${e.RID++}&AID=${e.AID}&zx=${i()}&t=1`,a=`count=1&ofs=1&req0___data__={"database":"projects/${e.database}/databases/(default)","removeTarget":${e.targetId}}`;await c(e,t,a,{"Content-Type":"application/x-www-form-urlencoded"}),e.closed=!0}}function h(e,t,a,n){const o={...e,documentPath:t,AID:0,RID:Math.round(64e3*Math.random())};try{d(o,(()=>f(o,a,n)))}catch(e){n&&n(e)}return()=>l(o)}const p=e=>{throw e};async function m(e,t,n,o,s){const r=function(e,t,a){t.startsWith(":")||(t="/"+t);let n=`${e.host}/v1/projects/${e.database}/databases/(default)/documents${t}`;if(a){const e=new URLSearchParams;Object.entries(a).map((([t,a])=>{["mask","updateMask","select","project"].includes(t)?(["select","project"].includes(t)&&(t="mask"),Array.isArray(a)||(a=[a]),a.map((a=>e.append(`${t}.fieldPaths`,a)))):e.append(t,a)})),n=`${n}?${e.toString()}`}return n}(e,t,n),i={method:o||"GET",mode:"cors",cache:"no-cache",headers:{pragma:"no-cache","cache-control":"no-cache"}},c=e.auth;c&&(i.headers.Authorization=`Bearer ${c.idToken}`),s&&(i.body=JSON.stringify(s));let d=await fetch(r,i),u=await d.json();if(!d.ok){if(Array.isArray(u)&&(u=u[0]),c&&401===u.error.code)return await c.tokenRefresh(),await m(e,t,n,o,s);p(u)}return a(u)}const g=e=>!(1&e.split("/").length),b=e=>{if(((e,t)=>{Array.isArray(e)||p(`"${t}" value must be an array`)})(e,"where"),Array.isArray(e[0]))return{compositeFilter:{op:"AND",filters:e.map((e=>b(e)))}};const[t,a,o]=e;a||p('"where" array needs 2 or 3 value');const s=o?"fieldFilter":"unaryFilter",r=(e=>({"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL","==":"EQUAL","=":"EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","!=":"NOT_EQUAL","<>":"NOT_EQUAL"}[e]||e.toUpperCase().replace(/\-/g,"_")))(a);r||p(`Invalid operator in where: ${a}`);const i={field:{fieldPath:t},op:r};return o&&(i.value=n(o)),{[s]:i}},w={listen:function(e,t,a){return h(this.dbinfo,e,t,a)},get:function(e,t){return(async(e,t,a)=>g(t)?m(e,t,a):p('Collection specified. Use "list" to get list of documents.'))(this.dbinfo,e,t)},query:function(e,t){return(async(e,t,a)=>{const o={};return Object.entries(t).map((([e,t])=>{const a=Array.isArray(t);switch(e){case"select":t={fields:a?t.map((e=>({fieldPath:e}))):[{fieldPath:t}]};break;case"from":t=a?t.map((e=>({collectionId:e}))):[{collectionId:t}];break;case"where":t=b(t);break;case"orderBy":const o=e=>{let t={};return e.startsWith("-")&&(e=e.slice(1),t.direction="DESCENDING"),t.field={fieldPath:e},t};t=a?t.map((e=>o(e))):[o(t)];break;case"startAt":case"startAfter":case"endAt":case"endBefore":t={values:[n(t)],before:["startAt","endBefore"].includes(e)},e=e.replace(/After|Before/,"At");break;default:t=n(t)}o[e]=t})),m(e,":runQuery",a,"POST",{structuredQuery:o})})(this.dbinfo,e,t)},list:function(e,t){return(async(e,t,a)=>g(t)?p('Document specified. Use "get" to get document.'):m(e,t,a))(this.dbinfo,e,t)},set:function(e,t,a){return(async(e,t,a,n)=>m(e,t,n,"PATCH",s(a)))(this.dbinfo,e,t,a)},update:function(e,t,a){return(async(e,t,a,n={})=>{const o=[],r=(e,t)=>{Object.entries(e).map((([e,a])=>{"Object"===a.constructor.name?r(a,`${t}${e}.`):o.push(t+e)}))};return r(a,""),n.updateMask=o,m(e,t,n,"PATCH",s(a))})(this.dbinfo,e,t,a)},delete:function(e,t){return(async(e,t,a)=>m(e,t,a,"DELETE"))(this.dbinfo,e,t)}};function y(e,t,a){const n={host:"https://firestore.googleapis.com",database:e,auth:t};return n.host=!1===a?"https://firestore.googleapis.com":a&&"string"==typeof a?a.startsWith("http")?a:`http://${a}`:"http://localhost:8080",{...w,dbinfo:n}}"undefined"!=typeof window&&(window.smallfire=window.smallfire||{},window.smallfire.getFirestoreDB=y);const A={get:function(e,t){return I(this.dbinfo,{dataPath:e,options:t})},set:function(e,t,a){return I(this.dbinfo,{dataPath:e,method:"PUT",value:t,options:a})},update:function(e,t,a){return I(this.dbinfo,{dataPath:e,method:"PATCH",value:t,options:a})},push:function(e,t,a){return I(this.dbinfo,{dataPath:e,method:"POST",value:t,options:a})},delete:function(e,t){return I(this.dbinfo,{dataPath:e,method:"DELETE",options:t})},listen:function(e,t,a){const n=T(this.dbinfo,{dataPath:e,options:a});let o,s,r;const i=async()=>{await this.dbinfo.auth.tokenRefresh(),d()},c=(e,a)=>{const{path:n,data:s}=JSON.parse(e),r=n.split("/").filter((e=>e.length)),i=r.pop();let c=o;r.forEach((e=>(c[e]=c[e]||{})&&(c=c[e]))),a?(i&&(c=c[i]),Object.assign(c,s)):i?null!==s?c[i]=s:delete c[i]:o=s,t(o,n,s)},d=()=>{s=new EventSource(n),s.onerror=function(){new Date-r>2e3?i():$("Error opening connection")},s.addEventListener("put",(e=>c(e.data))),s.addEventListener("patch",(e=>c(e.data,!0))),s.addEventListener("auth_revoked",(e=>i())),r=new Date};return d(),()=>s.close()}};function k(e,t,a){const n={host:"firebaseio.com",database:e,auth:t};if(a){const e={us:"firebaseio.com",europe:"europe-west1.firebasedatabase.app",asia:"asia-southeast1.firebasedatabase.app","us-central1":"firebaseio.com","europe-west1":"europe-west1.firebasedatabase.app","asia-southeast1":"asia-southeast1.firebasedatabase.app"};n.host=e[a]||a}return{...A,dbinfo:n}}const $=e=>{throw e};function T(e,{dataPath:t,options:a}){const{host:n,database:o,auth:s}=e;a&&Object.keys(a).map((function(e){const t=a[e];"string"!=typeof t||t.match(/^".*"$/)||(a[e]=`"${t}"`)}));const r=new URLSearchParams(a);s&&r.append("auth",s.idToken);let i=r.toString();return`https://${o}.${n}/${t}.json${i?"?"+i:""}`}async function I(e,{dataPath:t,method:a,value:n,options:o,headers:s}){const r=T(e,{dataPath:t,options:o}),i={method:a||"GET",mode:"cors",cache:"no-cache",headers:{pragma:"no-cache","cache-control":"no-cache"}};n&&(i.body=JSON.stringify(n)),s&&Object.assign(i.headers,s);let c=await fetch(r,i),d=await c.json();if(!c.ok){const s=e.auth;if(s&&401===c.status)return await s.tokenRefresh(),await I(e,{dataPath:t,method:a,value:n,options:o});$(d.error)}return d}"undefined"!=typeof window&&(window.smallfire=window.smallfire||{},window.smallfire.getFirebaseDB=k);const S={currentUser:function(){const e=localStorage.getItem("Firebase-Auth-Data");if(e){const t=JSON.parse(e);return t.tokenRefresh=_,t}},saveUser:D,signIn:async function(e,t,a){const n=await E("accounts:signInWithPassword",a,{email:e,password:t,returnSecureToken:!0});return n.apiKey=a,D(n),n.tokenRefresh=_,n},signOut:function(){localStorage.removeItem("Firebase-Auth-Data")}};function D(e){const{tokenRefresh:t,...a}=e;localStorage.setItem("Firebase-Auth-Data",JSON.stringify(a))}async function E(e,t,a,n){const o=`https://identitytoolkit.googleapis.com/v1/${e}?key=${t}`,s=await fetch(o,{method:"POST",mode:"cors",cache:"no-cache",headers:{pragma:"no-cache","cache-control":"no-cache","Content-Type":n||"application/json"},body:"string"==typeof a?a:JSON.stringify(a)}),r=await s.json();if(!s.ok)throw r;return r}async function _(){const e=await E("token",this.apiKey,`grant_type=refresh_token&refresh_token=${this.refreshToken}`,"application/x-www-form-urlencoded");this.idToken=e.id_token,this.refreshToken=e.refresh_token,D(this)}"undefined"!=typeof window&&(window.smallfire=window.smallfire||{},window.smallfire.auth=S);export{S as auth,k as getFirebaseDB,y as getFirestoreDB};
